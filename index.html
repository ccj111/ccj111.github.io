<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eth_sign è‡ªåŠ¨éªŒè¯ä¸å®‰å…¨æ°´ä½æµ‹è¯• PoC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2c3e50; }
        button { padding: 12px 20px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px;}
        button.danger { background-color: #dc3545; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}
        #console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 450px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; border: 2px solid #333; line-height: 1.4; }
        .info-box { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; border-radius: 4px; line-height: 1.5; }
    </style>
</head>
<body>
    <h2>Wallet eth_sign åº•å±‚é€»è¾‘è‡ªåŠ¨åŒ–é‰´å®šå™¨</h2>
    <div class="info-box">
        è¿™ä¸ª PoC ä¼šå¯¹é’±åŒ…è¿”å›çš„ç­¾åæ•°æ®ç«‹å³æ‰§è¡Œå¯†ç å­¦éªŒè¯ (ecrecover)ã€‚<br>
        å³ä½¿å‰ç«¯çœ‹èµ·æ¥æˆåŠŸè°ƒç”¨äº† <code>eth_sign</code>ï¼Œå®ƒä¹Ÿä¼šå¸®ä½ æ‰’å¼€åº•å±‚ï¼Œçœ‹çœ‹é’±åŒ…æ˜¯å¦å·å·å°†å…¶è½¬æ¢ä¸ºäº†å®‰å…¨çš„ <code>personal_sign</code> (EIP-191) æ¥è¿›è¡Œé˜²å¾¡ã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥æµ‹è¯•é’±åŒ…</button>
        å½“å‰åœ°å€: <span id="walletAddress" style="font-weight: bold; color: #007bff;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
        <button id="btnStandardSign" class="danger" disabled>2. å‘é€ eth_sign å¹¶è‡ªåŠ¨é‰´å®š</button>
    </div>

    <h3 style="margin-top: 30px;">è§£ææ§åˆ¶å°:</h3>
    <div id="console">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnStandardSign = document.getElementById('btnStandardSign');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');

        let currentAccount = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            elConsole.innerHTML += `[${time}] ${message}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        // 1. è¿æ¥é’±åŒ…
        btnConnect.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0].toLowerCase();
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚æµ‹è¯•åœ°å€: ${currentAccount}`);
                    btnStandardSign.disabled = false;
                } catch (error) {
                    log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`);
                }
            } else {
                log("âš ï¸ æœªæ£€æµ‹åˆ° window.ethereumï¼Œè¯·ç¡®ä¿é’±åŒ…æ’ä»¶å·²å¯ç”¨ã€‚");
            }
        });

        // 2. å‘é€è¯·æ±‚å¹¶è‡ªåŠ¨éªŒè¯
        btnStandardSign.addEventListener('click', async () => {
            if (!currentAccount) return;
            
            // æ„é€ ä¸€ä¸ª 32-byte çš„æµ‹è¯•å“ˆå¸Œ
            const payload = "0x89c9e5fa472f883b6f007bc9543e2621c1f55b9e0f34033dfd720c24298150a0";
            log(`\n--- ğŸš€ å‘é€ eth_sign è¯·æ±‚ ---`);
            log(`Payload (Hex): ${payload}`);
            
            try {
                // ç­‰å¾…ç”¨æˆ·åœ¨é’±åŒ…ä¸­ç‚¹å‡»ç­¾åç¡®è®¤
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, payload]
                });
                
                log(`âœ… æˆåŠŸæ‹¿åˆ°ç­¾åæ•°æ®:\n${signature}\n`);
                log(`ğŸ” æ­£åœ¨è°ƒç”¨ ethers.js è¿›è¡Œå¯†ç å­¦åæ¨éªŒè¯...`);

                // æ‹¿åˆ°ç­¾ååï¼Œç¬é—´åœ¨æœ¬åœ°æ‰§è¡ŒéªŒè¯é€»è¾‘
                verifySignature(payload, signature, currentAccount);

            } catch (error) {
                log(`ğŸ›¡ï¸ è¯·æ±‚è¢«æ‹¦æˆªæˆ–ç”¨æˆ·å–æ¶ˆ: ${error.message}`);
            }
        });

        // 3. æ ¸å¿ƒå¯†ç å­¦éªŒè¯é€»è¾‘
        function verifySignature(payload, signature, address) {
            if (typeof ethers === 'undefined') {
                log("âŒ ethers.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDNã€‚");
                return;
            }

            let isEthSign = false;
            let isPersonalSign = false;

            // æµ‹è¯• A: éªŒè¯æ˜¯å¦ä¸ºçº¯æ­£çš„ã€æ— å‰ç¼€çš„ eth_sign ç›²ç­¾
            try {
                const recoveredEth = ethers.recoverAddress(payload, signature).toLowerCase();
                if (recoveredEth === address) {
                    isEthSign = true;
                }
            } catch (e) {
                console.error("eth_sign æ¢å¤é”™è¯¯:", e);
            }

            // æµ‹è¯• B: éªŒè¯æ˜¯å¦è¢«å·å·åŠ ä¸Šäº† EIP-191 å‰ç¼€ (å˜æˆäº† personal_sign)
            try {
                const payloadBytes = ethers.getBytes(payload);
                const recoveredPersonal = ethers.verifyMessage(payloadBytes, signature).toLowerCase();
                if (recoveredPersonal === address) {
                    isPersonalSign = true;
                }
            } catch (e) {
                console.error("personal_sign æ¢å¤é”™è¯¯:", e);
            }

            // æ‰“å°æœ€ç»ˆé‰´å®šç»“è®º
            if (isEthSign) {
                log(`ğŸš¨ [æåº¦å±é™©] é‰´å®šç»“æœï¼šè¿™æ˜¯çœŸå®çš„ eth_sign ç›²ç­¾ï¼`);
                log(`ğŸ‘‰ é’±åŒ…æ²¡æœ‰è¿›è¡Œä»»ä½•å‰ç¼€ä¿æŠ¤ï¼Œç›´æ¥å¯¹è£¸å“ˆå¸Œè¿›è¡Œäº†ç­¾åã€‚æ”»å‡»è€…å¯è½»æ˜“åˆ©ç”¨æ­¤æ¼æ´ç›—å–èµ„äº§ã€‚`);
            } else if (isPersonalSign) {
                log(`ğŸ›¡ï¸ [å®‰å…¨ä¼ªè£…] é‰´å®šç»“æœï¼šå·²è¢«å®‰å…¨è½¬æ¢ä¸º personal_signï¼`);
                log(`ğŸ‘‰ é’±åŒ… UI ä¸Šè™½ç„¶çœ‹èµ·æ¥åƒæ˜¯å¤„ç†äº† eth_signï¼Œä½†åº•å±‚å¼ºåˆ¶åŠ ä¸Šäº† EIP-191 å‰ç¼€ã€‚è¿™ç¬”ç­¾åæ— æ³•ä½œä¸ºæ¶æ„äº¤æ˜“è¢«å¹¿æ’­ï¼Œèµ„äº§æ˜¯å®‰å…¨çš„ã€‚`);
            } else {
                log(`â“ [æœªçŸ¥æ ‡å‡†] é‰´å®šç»“æœï¼šæ— æ³•åŒ¹é…ä¸»æµæ ‡å‡†ï¼Œé’±åŒ…å¯èƒ½ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ç­¾ååŠ å¯†ç®—æ³•ã€‚`);
            }
        }
    </script>
</body>
</html>
