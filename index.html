<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eth_sign æ·±åº¦é€†å‘ä¸è‡ªåŠ¨åŒ–é‰´å®š PoC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2c3e50; }
        button { padding: 12px 20px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px;}
        button.danger { background-color: #dc3545; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}
        #console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 450px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; border: 2px solid #333; line-height: 1.4; }
        .info-box { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; border-radius: 4px; line-height: 1.5; }
        .highlight { font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <h2>Wallet eth_sign æ·±åº¦é€†å‘ä¸è‡ªåŠ¨åŒ–é‰´å®šå™¨</h2>
    <div class="info-box">
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong><br>
        1. ç»•è¿‡ Provider å±‚çš„åœ°å€æ ¡éªŒæ‹¦æˆªï¼ŒæˆåŠŸå”¤èµ·ç­¾å UIã€‚<br>
        2. æ‹¿åˆ°ç­¾ååï¼Œåˆ©ç”¨ <code>ethers.js</code> ç¬é—´åæ¨ï¼Œé‰´å®šåº•å±‚æ˜¯ <strong>çœŸç›²ç­¾</strong> è¿˜æ˜¯ <strong>EIP-191 å®‰å…¨åŒ…è£…</strong>ã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥æµ‹è¯•é’±åŒ…</button>
        å½“å‰åœ°å€: <span id="walletAddress" style="font-weight: bold; color: #007bff;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
        <button id="btnStandardSign" class="danger" disabled>2. å”¤èµ· eth_sign å¹¶è‡ªåŠ¨é‰´å®š</button>
    </div>

    <h3 style="margin-top: 30px;">è§£ææ§åˆ¶å°:</h3>
    <div id="console">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnStandardSign = document.getElementById('btnStandardSign');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');

        let currentAccount = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            elConsole.innerHTML += `[${time}] ${message}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        // 1. è¿æ¥é’±åŒ… (ä¿®å¤ç‚¹ï¼šä¿ç•™åŸå§‹çš„å¤§å°å†™æ ¡éªŒå’Œæ ¼å¼)
        btnConnect.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    // ã€ä¿®å¤å…³é”®ã€‘ï¼šä¸è¦åœ¨è¿™é‡Œä½¿ç”¨ toLowerCase()ï¼Œä¿ç•™åŸå§‹çš„ EIP-55 æ ¡éªŒå’Œæ ¼å¼
                    // å¦åˆ™ä¼šè¢«é’±åŒ…åº•å±‚çš„ Provider ç¬é—´æ‹¦æˆªï¼
                    currentAccount = accounts[0]; 
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚å½“å‰æ¿€æ´»åœ°å€: ${currentAccount}`);
                    btnStandardSign.disabled = false;
                } catch (error) {
                    log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`);
                }
            } else {
                log("âš ï¸ æœªæ£€æµ‹åˆ° window.ethereumï¼Œè¯·ç¡®ä¿é’±åŒ…æ’ä»¶å·²å¯ç”¨ã€‚");
            }
        });

        // 2. å‘é€è¯·æ±‚å¹¶è‡ªåŠ¨éªŒè¯
        btnStandardSign.addEventListener('click', async () => {
            if (!currentAccount) return;
            
            // æ„é€ ä¸€ä¸ª 32-byte çš„æµ‹è¯•å“ˆå¸Œ
            const payload = "0x89c9e5fa472f883b6f007bc9543e2621c1f55b9e0f34033dfd720c24298150a0";
            log(`\n--- ğŸš€ å‘é€ eth_sign è¯·æ±‚ ---`);
            log(`ä¼ å…¥ Provider çš„ Address: ${currentAccount}`);
            log(`Payload (Hex): ${payload}`);
            
            try {
                // å‘é€è¯·æ±‚ï¼Œæ­¤æ—¶åœ°å€æ ¼å¼ä¸é’±åŒ…å†…éƒ¨æ¿€æ´»åœ°å€å®Œå…¨ä¸€è‡´ï¼Œä¸ä¼šè§¦å‘ç¬é—´æ‹¦æˆª
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, payload]
                });
                
                log(`âœ… æˆåŠŸæ‹¿åˆ°ç­¾åæ•°æ®:\n${signature}\n`);
                log(`ğŸ” æ­£åœ¨è°ƒç”¨ ethers.js è¿›è¡Œå¯†ç å­¦åæ¨é‰´å®š...`);

                // æ‹¿åˆ°ç­¾ååæ‰§è¡ŒéªŒè¯é€»è¾‘ã€‚
                // ã€æ³¨æ„ã€‘ï¼šä¸ºäº†é…åˆ ethers.js çš„æ¯”å¯¹ï¼Œæ­¤æ—¶å°†åœ°å€è½¬ä¸ºå°å†™ä¼ å…¥
                verifySignature(payload, signature, currentAccount.toLowerCase());

            } catch (error) {
                log(`ğŸ›¡ï¸ è¯·æ±‚è¢«æ‹¦æˆªæˆ–ç”¨æˆ·å–æ¶ˆ: ${error.message}`);
            }
        });

        // 3. æ ¸å¿ƒå¯†ç å­¦éªŒè¯é€»è¾‘
        function verifySignature(payload, signature, addressLowerCase) {
            if (typeof ethers === 'undefined') {
                log("âŒ ethers.js åŠ è½½å¤±è´¥ï¼Œæ— æ³•è¿›è¡ŒéªŒè¯ã€‚");
                return;
            }

            let isEthSign = false;
            let isPersonalSign = false;

            // æµ‹è¯• A: éªŒè¯æ˜¯å¦ä¸ºçº¯æ­£çš„ã€æ— å‰ç¼€çš„ eth_sign ç›²ç­¾
            try {
                const recoveredEth = ethers.recoverAddress(payload, signature).toLowerCase();
                if (recoveredEth === addressLowerCase) {
                    isEthSign = true;
                }
            } catch (e) {
                console.error("eth_sign æ¢å¤é”™è¯¯:", e);
            }

            // æµ‹è¯• B: éªŒè¯æ˜¯å¦è¢«å·å·åŠ ä¸Šäº† EIP-191 å‰ç¼€ (å˜æˆäº† personal_sign)
            try {
                const payloadBytes = ethers.getBytes(payload);
                const recoveredPersonal = ethers.verifyMessage(payloadBytes, signature).toLowerCase();
                if (recoveredPersonal === addressLowerCase) {
                    isPersonalSign = true;
                }
            } catch (e) {
                console.error("personal_sign æ¢å¤é”™è¯¯:", e);
            }

            // æ‰“å°æœ€ç»ˆé‰´å®šç»“è®º
            if (isEthSign) {
                log(`ğŸš¨ [æåº¦å±é™©] é‰´å®šç»“æœï¼šè¿™æ˜¯çœŸå®çš„ eth_sign ç›²ç­¾ï¼`);
                log(`ğŸ‘‰ é’±åŒ…ç›´æ¥å¯¹è£¸å“ˆå¸Œè¿›è¡Œäº†ç­¾åï¼Œæ²¡æœ‰å®æ–½å‰ç¼€ä¿æŠ¤ã€‚`);
            } else if (isPersonalSign) {
                log(`ğŸ›¡ï¸ [å®‰å…¨ä¼ªè£…] é‰´å®šç»“æœï¼šå·²è¢«åº•å±‚è½¬æ¢ä¸º personal_signï¼`);
                log(`ğŸ‘‰ é’±åŒ… UI è™½æ˜¾ç¤º eth_sign é€»è¾‘ï¼Œä½†åº•å±‚å¼ºåˆ¶å¢åŠ äº† EIP-191 æ¶ˆæ¯å‰ç¼€ã€‚æ­¤ç­¾åæ— æ³•ä½œä¸ºæ¶æ„äº¤æ˜“å¹¿æ’­ã€‚`);
            } else {
                log(`â“ [æœªçŸ¥æ ‡å‡†] é‰´å®šç»“æœï¼šæ— æ³•åŒ¹é…ä¸»æµæ ‡å‡†ï¼Œå¯èƒ½ä¸ºè‡ªå®šä¹‰ç­¾åæˆ–å­˜åœ¨å…¶ä»–æ··æ·†ã€‚`);
            }
        }
    </script>
</body>
</html>
