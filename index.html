<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eth_sign å®‰å…¨æ°´ä½ä¸ UI æˆªæ–­æµ‹è¯• PoC</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2c3e50; }
        button { padding: 12px 20px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px;}
        button.danger { background-color: #dc3545; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}
        #console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 350px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; border: 2px solid #333; }
        .info-box { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #007bff; border-radius: 4px; line-height: 1.5; }
        .highlight { font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <h2>Wallet eth_sign Security Tester</h2>
    <div class="info-box">
        æ­¤ PoC è„šæœ¬é€šè¿‡è°ƒç”¨ <code>window.ethereum</code> æ¥å£ï¼Œç›´æ¥å‘å½“å‰æµè§ˆå™¨æ³¨å…¥çš„ Web3 é’±åŒ…å‘é€ <code>eth_sign</code> RPC è¯·æ±‚ã€‚<br><br>
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong><br>
        1. æ¢é’ˆ Aï¼šæµ‹è¯•é’±åŒ…æ˜¯å¦ä»åº•å±‚æˆ– UI å±‚é¢æ‹¦æˆªäº†é«˜å±çš„è£¸å“ˆå¸Œç›²ç­¾ã€‚<br>
        2. æ¢é’ˆ Bï¼šæµ‹è¯•é’±åŒ…çš„ UI æ¸²æŸ“å¼•æ“æ˜¯å¦å­˜åœ¨ <code>\x00</code> (Null Byte) æˆªæ–­è§†è§‰æ¬ºéª—æ¼æ´ã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥é’±åŒ… (è·å–æˆæƒ)</button>
        å½“å‰æµ‹è¯•åœ°å€: <span id="walletAddress" style="font-weight: bold; color: #007bff;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
        <button id="btnStandardSign" class="danger" disabled>2. æ¢é’ˆ A: å‘é€æ ‡å‡† eth_sign è¯·æ±‚</button>
        <button id="btnNullByteSign" class="danger" disabled>3. æ¢é’ˆ B: å‘é€ 0x00 æˆªæ–­ Payload</button>
    </div>

    <h3 style="margin-top: 30px;">æµ‹è¯•è¾“å‡ºæ—¥å¿— (Console):</h3>
    <div id="console">ç­‰å¾…æ“ä½œåˆå§‹åŒ–...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnStandardSign = document.getElementById('btnStandardSign');
        const btnNullByteSign = document.getElementById('btnNullByteSign');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');

        let currentAccount = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            elConsole.innerHTML += `[${time}] ${message}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        // 1. è¿æ¥é’±åŒ…è·å–åœ°å€
        btnConnect.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    log("æ­£åœ¨å‘ provider å‘é€ eth_requestAccounts è¯·æ±‚...");
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0];
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚å½“å‰åœ°å€: ${currentAccount}`);
                    btnStandardSign.disabled = false;
                    btnNullByteSign.disabled = false;
                } catch (error) {
                    log(`âŒ è¿æ¥è¢«æ‹’ç»æˆ–å‡ºé”™: ${error.message} (Code: ${error.code})`);
                }
            } else {
                log("âš ï¸ æœªæ£€æµ‹åˆ° window.ethereum æä¾›è€…ï¼è¯·ç¡®ä¿ä½ å·²åœ¨æµè§ˆå™¨ä¸­å®‰è£…å¹¶å¯ç”¨äº†é’±åŒ…æ’ä»¶ã€‚");
            }
        });

        // 2. æ ‡å‡† eth_sign æµ‹è¯•
        btnStandardSign.addEventListener('click', async () => {
            if (!currentAccount) return;
            // æ„é€ ä¸€ä¸ªæ¨¡æ‹Ÿçš„ 32-byte äº¤æ˜“å“ˆå¸Œçš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²
            const payload = "0x89c9e5fa472f883b6f007bc9543e2621c1f55b9e0f34033dfd720c24298150a0";
            log(`\n--- ğŸš€ æ‰§è¡Œæ¢é’ˆ A: æ ‡å‡† eth_sign ---`);
            log(`å‘é€çš„ Payload (æ¨¡æ‹Ÿæ¶æ„äº¤æ˜“å“ˆå¸Œ): ${payload}`);
            
            try {
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, payload]
                });
                log(`ğŸš¨ [é«˜å±] é’±åŒ…æœªå®æ–½æ‹¦æˆªï¼æˆåŠŸæ‹¿åˆ°ç­¾å:\n${signature}`);
            } catch (error) {
                log(`ğŸ›¡ï¸ [å®‰å…¨] é’±åŒ…æˆåŠŸæ‹¦æˆªæˆ–ä½ æ‹’ç»äº†è¯·æ±‚ã€‚\nè¿”å›ä¿¡æ¯: ${error.message} (Code: ${error.code})`);
            }
        });

        // 3. 0x00 æˆªæ–­ (Null Byte Truncation) æµ‹è¯•
        btnNullByteSign.addEventListener('click', async () => {
            if (!currentAccount) return;
            // æ„é€  Payload: "SafeMessage\x00EvilData" çš„ Hex ç¼–ç 
            // "SafeMessage" -> 536166654d657373616765
            // "\x00"        -> 00
            // "EvilData"    -> 4576696c44617461
            const payload = "0x536166654d657373616765004576696c44617461";
            
            log(`\n--- ğŸš€ æ‰§è¡Œæ¢é’ˆ B: 0x00 UI æˆªæ–­æµ‹è¯• ---`);
            log(`å‘é€çš„ Payload (Hex): ${payload}`);
            log(`ğŸ” è§‚å¯Ÿç‚¹ï¼šè¯·ä»”ç»†æŸ¥çœ‹é’±åŒ…å¼¹å‡ºçš„ç­¾åç¡®è®¤ç•Œé¢ã€‚`);
            log(`å¦‚æœç•Œé¢ä¸Šåªèƒ½çœ‹åˆ° "SafeMessage" (æˆ–å¯¹åº”çš„ ASCII è§£æ)ï¼Œè€Œ "EvilData" å‡­ç©ºæ¶ˆå¤±äº†ï¼Œè¯´æ˜è¯¥é’±åŒ…å­˜åœ¨è§†è§‰æˆªæ–­æ¼æ´ï¼`);
            
            try {
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, payload]
                });
                log(`ğŸš¨ [é«˜å±] è·å–åˆ°ç­¾åï¼UI å¯èƒ½è¢«æˆåŠŸæ¬ºéª—:\n${signature}`);
            } catch (error) {
                 log(`ğŸ›¡ï¸ [å®‰å…¨æˆ–å–æ¶ˆ] è¯·æ±‚æœªå®Œæˆã€‚\nè¿”å›ä¿¡æ¯: ${error.message} (Code: ${error.code})`);
            }
        });
    </script>
</body>
</html>
